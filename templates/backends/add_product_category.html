{% extends 'base/base.html' %}
{% load static %}

{% block title %}Ethereal - Add Product Category{% endblock %}

{% block content %}
<section class="pt-28 pb-24">
	<div class="flex flex-col lg:flex-row min-h-[calc(100vh-7rem)]">
		{% include 'backends/partials/sidebar.html' with sidebar_title='Add Product Category' %}

		<div class="flex-1 px-6 lg:px-12 xl:px-16 py-10">
			<div class="max-w-4xl">
				<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8 mb-12">
					<div>
						<p class="text-xs tracking-[0.4em] uppercase text-twilight dark:text-lavender-mist mb-3">Backends</p>
						<h2 class="font-cormorant text-4xl lg:text-5xl text-obsidian dark:text-pearl font-light">Assign Product Category</h2>
					</div>
					<a href="{% url 'backends:product' %}"
						class="btn px-6 py-3 text-xs tracking-[0.25em] uppercase border border-solid border-obsidian/20 dark:border-pearl/20 text-obsidian dark:text-pearl hover:text-mint hover:border-mint/50 hover:scale-105 transition-all duration-300">Back to Products</a>
				</div>

				<div class="rounded-3xl border border-solid border-obsidian/10 dark:border-pearl/10 bg-moon-white/85 dark:bg-black-pearl/70 p-8 shadow-[0_30px_60px_rgba(27,26,23,0.08)] card-glow">
					{% if error %}
						<div class="mb-6 rounded-2xl border border-solid border-mint/40 bg-emerald-500/10 text-mint px-4 py-3 text-sm">
							{{ error }}
						</div>
					{% endif %}

					<form method="post" class="space-y-6">
						{% csrf_token %}
						<div>
							<div class="flex items-center justify-between mb-2">
								<label class="block text-xs tracking-[0.25em] uppercase text-twilight dark:text-lavender-mist" for="product-select">Product</label>
								<button type="button" onclick="refreshProducts()" title="Refresh product list"
									class="text-xs text-mint hover:text-obsidian dark:hover:text-pearl transition-all duration-300">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
									</svg>
								</button>
							</div>
							<select id="product-select" name="product" required
								class="w-full rounded-2xl border border-solid border-obsidian/15 dark:border-pearl/15 bg-moon-white/70 dark:bg-black-pearl/40 px-4 py-3 text-sm text-obsidian dark:text-pearl focus:border-mint focus:ring-2 focus:ring-mint/20 focus:outline-none transition-all duration-200">
								<option value="" disabled selected>Select a product</option>
								{% for product in products %}
									<option value="{{ product.id }}">{{ product.name }}</option>
								{% endfor %}
							</select>
							<a href="{% url 'backends:add_product' %}" target="_blank"
								class="btn inline-block mt-2 text-xs text-twilight dark:text-lavender-mist hover:text-mint hover:border-mint/50 hover:scale-105 transition-all duration-300">+ Add New Product</a>
						</div>
						<div>
							<div class="flex items-center justify-between mb-2">
								<label class="block text-xs tracking-[0.25em] uppercase text-twilight dark:text-lavender-mist" for="category-select">Category</label>
								<button type="button" onclick="refreshCategories()" title="Refresh category list"
									class="text-xs text-mint hover:text-obsidian dark:hover:text-pearl transition-all duration-300">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
									</svg>
								</button>
							</div>
							<select id="category-select" name="category" required
								class="w-full rounded-2xl border border-solid border-obsidian/15 dark:border-pearl/15 bg-moon-white/70 dark:bg-black-pearl/40 px-4 py-3 text-sm text-obsidian dark:text-pearl focus:border-mint focus:ring-2 focus:ring-mint/20 focus:outline-none transition-all duration-200">
								<option value="" disabled selected>Select a category</option>
								{% for category in categories %}
									<option value="{{ category.id }}">{{ category.name }}</option>
								{% endfor %}
							</select>
							<a href="{% url 'backends:add_category' %}" target="_blank"
								class="btn inline-block mt-2 text-xs text-twilight dark:text-lavender-mist hover:text-mint hover:border-mint/50 hover:scale-105 transition-all duration-300">+ Add New Category</a>
						</div>
						<div class="flex flex-wrap gap-4">
							<button type="submit"
								class="btn px-6 py-3 text-xs tracking-[0.25em] uppercase bg-obsidian text-moon-white dark:bg-pearl dark:text-obsidian hover:bg-mint hover:shadow-[0_8px_30px_rgba(82,183,136,0.3)] hover:scale-105 transition-all duration-300">Save Product Category</button>
							<a href="{% url 'backends:product' %}"
								class="btn px-6 py-3 text-xs tracking-[0.25em] uppercase border border-solid border-obsidian/20 dark:border-pearl/20 text-obsidian dark:text-pearl hover:text-mint hover:border-mint/50 hover:scale-105 transition-all duration-300">Cancel</a>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</section>

<script>
	// Refresh product dropdown
	async function refreshProducts() {
		const select = document.getElementById('product-select');
		const currentValue = select.value;
		
		try {
			const response = await fetch('{% url "backends:get-products-json" %}');
			const products = await response.json();
			
			// Clear existing options except the first one
			select.innerHTML = '<option value="" disabled selected>Select a product</option>';
			
			// Add updated options
			products.forEach(product => {
				const option = document.createElement('option');
				option.value = product.id;
				option.textContent = product.name;
				if (product.id == currentValue) {
					option.selected = true;
				}
				select.appendChild(option);
			});
			
			// Show success feedback
			showRefreshFeedback('Products refreshed');
		} catch (error) {
			console.error('Error refreshing products:', error);
			showRefreshFeedback('Error refreshing products', true);
		}
	}
	
	// Refresh category dropdown
	async function refreshCategories() {
		const select = document.getElementById('category-select');
		const currentValue = select.value;
		
		try {
			const response = await fetch('{% url "backends:get-categories-json" %}');
			const categories = await response.json();
			
			// Clear existing options except the first one
			select.innerHTML = '<option value="" disabled selected>Select a category</option>';
			
			// Add updated options
			categories.forEach(category => {
				const option = document.createElement('option');
				option.value = category.id;
				option.textContent = category.name;
				if (category.id == currentValue) {
					option.selected = true;
				}
				select.appendChild(option);
			});
			
			// Show success feedback
			showRefreshFeedback('Categories refreshed');
		} catch (error) {
			console.error('Error refreshing categories:', error);
			showRefreshFeedback('Error refreshing categories', true);
		}
	}
	
	// Show temporary feedback message
	function showRefreshFeedback(message, isError = false) {
		const feedback = document.createElement('div');
		feedback.className = `fixed top-20 right-6 px-4 py-2 rounded-lg text-xs ${
			isError 
				? 'bg-emerald-500/90 text-moon-white' 
				: 'bg-obsidian/90 dark:bg-pearl/90 text-moon-white dark:text-obsidian'
		} shadow-lg z-50 animate-fade-in`;
		feedback.textContent = message;
		document.body.appendChild(feedback);
		
		setTimeout(() => {
			feedback.remove();
		}, 2000);
	}
	
	// Auto-refresh when window regains focus (after adding in new tab)
	window.addEventListener('focus', function() {
		// Small delay to ensure new data is saved
		setTimeout(() => {
			refreshProducts();
			refreshCategories();
		}, 500);
	});
</script>

<style>
	@keyframes fade-in {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
	
	.animate-fade-in {
		animation: fade-in 0.3s ease-out;
	}
</style>

{% endblock %}






